# .github/workflows/deploy-pages.yml
name: Build & Deploy MCP Servers Site

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build mcp-servers.json & Upload Artifact
    runs-on: ubuntu-latest
    permissions:
      contents: read       # for checkout / discovery.json
      id-token: write      # required by upload-pages-artifact@v3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Generate mcp-servers.json
        run: |
          WEBSITE_DIR=assets/website
          mkdir -p "$WEBSITE_DIR"

          # Collect all card.json
          TMP=$(mktemp)
          find . -maxdepth 1 -type d -name 'mcp-server*' | while read DIR; do
            CARD="$DIR/card.json"
            [ -f "$CARD" ] && cat "$CARD"
          done | jq -s '.' > "$TMP"

          # Merge with discovery.json, preferring card.json overrides
          jq -s '
            .[0] as $disc |
            .[1] as $cards |
            $disc
            | map( ( $cards[]? | select(.id == .id) ) // . )
          ' assets/website/discovery.json "$TMP" \
            > assets/website/mcp-servers.json

          rm "$TMP"
          echo "✓ Generated $(jq length assets/website/mcp-servers.json) entries."

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: assets/website

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write        # publish
      id-token: write     # authenticate
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        # (no additional with: needed — it picks up the artifact from the build job)
